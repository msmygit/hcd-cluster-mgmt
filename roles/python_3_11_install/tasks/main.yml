---
- name: Debug ansible_os_family
  debug:
    msg: "ansible_os_family is {{ ansible_os_family }} & ansible_distribution is {{ ansible_distribution }}"

- name: Install Python 3.11 on Debian/Ubuntu
  when: ansible_os_family == "Debian"
  block:
    - name: Add deadsnakes PPA (Ubuntu only)
      apt_repository:
        repo: ppa:deadsnakes/ppa
        state: present
      when: ansible_distribution == "Ubuntu"

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install python3.11 and venv/dev package
      apt:
        name:
          - python3.11
          - python3.11-venv
          - python3.11-dev
          - libffi-dev
        state: present

- name: Install Python 3.11 on RedHat / RHEL / CentOS / Fedora
  when: ansible_os_family == "RedHat"
  block:
    - name: Install python3.11 (and pip) via dnf/yum
      package:
        name:
          - python3.11
          - python3.11-devel        # if you need dev headers
          - python3.11-pip
        state: present

# [WARNING]: Unable to use '/home/cassandra/.ansible/tmp' as temporary directory, falling back to system default: [Errno 13] Permission denied: '/home/cassandra'
# Unable to use '/home/cassandra/.ansible/tmp' as temporary directory, falling back to system default.
# <<< caused by >>>
# [Errno 13] Permission denied: '/home/cassandra'

- name: Create Python 3.11 venv for cqlsh
  #become_user: "{{ cassandra_user }}"
  shell: |
    python3.11 -m venv {{ cassandra_venv }}
    source {{ cassandra_venv }}/bin/activate && pip install --upgrade pip && pip install six cassandra-driver
  args:
    executable: /bin/bash
    creates: "{{ cassandra_venv }}/bin/activate"

- name: Optional â€” configure alternatives / symlink for python3
  # vars:
  #   python_make_default: true     # you can set this to false if you want to skip
  when: python_make_default | bool
  block:
    - name: Ensure /usr/bin/python3.11 is first in alternatives (Debian/RedHat)
      alternatives:
        name: python3
        path: /usr/bin/python3.11
        priority: 50

    - name: (Optional) Update /usr/bin/python symlink to python3.11
      file:
        src: /usr/bin/python3.11
        dest: /usr/bin/python
        state: link
      # Be careful: only enable if you know your system supports it


#export CQLSH_PYTHON=/usr/bin/python3.11